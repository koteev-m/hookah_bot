name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  backend-ktlint:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: true
      matrix:
        java: [21]
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Set up Java
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@0b6dd653ba04f4f93bf581ec31e66cbd7dcb644d # v4
        with:
          cache-key-prefix: ${{ runner.os }}-gradle-${{ hashFiles('gradle.properties', 'gradle/libs.versions.toml', 'settings.gradle.kts', 'gradle/wrapper/gradle-wrapper.properties') }}
      - name: Run ktlint
        run: ./gradlew :backend:app:ktlintCheck

  backend-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    strategy:
      fail-fast: true
      matrix:
        java: [21]
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Set up Java
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@0b6dd653ba04f4f93bf581ec31e66cbd7dcb644d # v4
        with:
          cache-key-prefix: ${{ runner.os }}-gradle-${{ hashFiles('gradle.properties', 'gradle/libs.versions.toml', 'settings.gradle.kts', 'gradle/wrapper/gradle-wrapper.properties') }}
      - name: Verify Docker availability (required for Testcontainers)
        run: docker info
      - name: Run backend tests
        run: ./gradlew :backend:app:test

  backend:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ always() }}
    needs: [backend-ktlint, backend-tests]
    steps:
      - name: Aggregate backend checks
        run: |
          echo "backend-ktlint result: ${{ needs.backend-ktlint.result }}"
          echo "backend-tests result: ${{ needs.backend-tests.result }}"

          if [[ "${{ needs.backend-ktlint.result }}" != "success" || "${{ needs.backend-tests.result }}" != "success" ]]; then
            echo "backend checks failed"
            exit 1
          fi

          echo "backend checks passed"

  miniapp:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: true
      matrix:
        node: [20]
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ matrix.node }}
      - name: Detect miniapp lockfile
        id: miniapp-lockfile
        run: |
          cd miniapp
          lockfiles=()
          if [ -f pnpm-lock.yaml ]; then
            lockfiles+=("pnpm-lock.yaml")
          fi
          if [ -f package-lock.json ]; then
            lockfiles+=("package-lock.json")
          fi
          if [ -f yarn.lock ]; then
            lockfiles+=("yarn.lock")
          fi
          if [ ${#lockfiles[@]} -eq 0 ]; then
            echo "::error::No lockfile found in miniapp/. Expected pnpm-lock.yaml, package-lock.json, or yarn.lock."
            exit 1
          fi
          if [ ${#lockfiles[@]} -gt 1 ]; then
            echo "::warning::Multiple lockfiles detected in miniapp/: ${lockfiles[*]}. Using priority pnpm > npm > yarn."
          fi
          if [ -f pnpm-lock.yaml ]; then
            echo "package_manager=pnpm" >> "$GITHUB_OUTPUT"
          elif [ -f package-lock.json ]; then
            echo "package_manager=npm" >> "$GITHUB_OUTPUT"
          else
            echo "package_manager=yarn" >> "$GITHUB_OUTPUT"
          fi
      - name: Set up pnpm
        if: steps.miniapp-lockfile.outputs.package_manager == 'pnpm'
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 9
      - name: Install dependencies
        working-directory: miniapp
        run: |
          case "${{ steps.miniapp-lockfile.outputs.package_manager }}" in
            pnpm)
              pnpm install --frozen-lockfile
              ;;
            npm)
              npm ci
              ;;
            yarn)
              corepack enable
              yarn install --frozen-lockfile
              ;;
            *)
              echo "::error::Unknown package manager."
              exit 1
              ;;
          esac
      - name: Build miniapp
        working-directory: miniapp
        run: |
          case "${{ steps.miniapp-lockfile.outputs.package_manager }}" in
            pnpm)
              pnpm build
              ;;
            npm)
              npm run build
              ;;
            yarn)
              yarn build
              ;;
            *)
              echo "::error::Unknown package manager."
              exit 1
              ;;
          esac

  docker:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: true
      matrix:
        target: [backend]
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Build backend image
        run: docker build -f backend/Dockerfile .
