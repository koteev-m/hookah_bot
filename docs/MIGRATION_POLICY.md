# Migration policy (Flyway)

Документ описывает безопасный процесс валидации и применения миграций без даунтайма.

## Политика для CI

1. Любое изменение схемы должно идти через Flyway-миграции (`classpath:db/migration/...`).
2. В CI обязательно выполняются:
   - `./gradlew :backend:app:ktlintCheck`
   - `./gradlew :backend:app:test` (включая Testcontainers-сценарии, требуется Docker)
3. Валидация миграций в CI выполняется тестами, которые запускают Flyway `validate + migrate` на H2/Postgres.
   Минимальная проверка локально:
   - `./gradlew :backend:app:test --tests "*Migration*"`

> Даже если SQL-миграции в PR не менялись, `:backend:app:test` остаётся обязательным, чтобы поймать рассинхрон схемы и кода.

## Применение миграций в production

1. Миграции применяются автоматически на старте backend через `DatabaseFactory` (Flyway).
2. Для безопасного выката:
   - сначала запустить один инстанс новой версии (canary/pre-deploy),
   - дождаться успешного завершения Flyway в логах,
   - затем раскатывать остальные инстансы.
3. После старта проверить `GET /db/health` и отсутствие ошибок Flyway в логах.

## Правила безопасности миграций

- Не редактировать уже применённые versioned-миграции (`V*__*.sql`), добавлять только новую версию.
- Для потенциально долгих DDL использовать совместимую, поэтапную стратегию (expand/contract).
- Любые destructive-операции (`DROP`, массовые `UPDATE`) предварительно прогонять на staging/restore-копии.
